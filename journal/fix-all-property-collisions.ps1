# Universal Property Name Collision Fixer
# Pluralizes first property when it matches class name

$ErrorActionPreference = "Stop"

Write-Host "`n??????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?      UNIVERSAL FIX: Property Name Collision Resolver       ?" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????????????????????????`n" -ForegroundColor Cyan

$generatedPath = "lib\EasyAF.Data\Models\Generated"
$files = Get-ChildItem "$generatedPath\*.cs"

$fixedCount = 0

foreach ($file in $files) {
    $className = $file.BaseName
    $content = Get-Content $file.FullName -Raw
    
    # Check if first property matches class name
    if ($content -match "public string\? $className \{") {
        $pluralName = $className + "s"
        
        Write-Host "Fixing $className ? $pluralName..." -ForegroundColor Yellow
        
        # Replace property declaration
        $content = $content -replace "public string\? $className \{", "public string? $pluralName {"
        
        # Replace Id alias getter/setter
        $content = $content -replace "get => $className;", "get => $pluralName;"
        $content = $content -replace "set => $className = value;", "set => $pluralName = value;"
        
        # Replace ToString reference
        $content = $content -replace "\`$$className: \{$className\}", "`$$className: {$pluralName}"
        
        Set-Content $file.FullName $content
        $fixedCount++
        Write-Host "  ? Fixed $className" -ForegroundColor Green
    }
}

Write-Host "`n??????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "Fixed $fixedCount property name collisions" -ForegroundColor Green
Write-Host "??????????????????????????????????????????????????????????`n" -ForegroundColor Cyan

# Deploy to Models
Write-Host "Deploying to Models folder..." -ForegroundColor Yellow
Copy-Item "$generatedPath\*.cs" -Destination "lib\EasyAF.Data\Models\" -Force
Write-Host "? Deployed 34 models`n" -ForegroundColor Green

# Build test
Write-Host "Building..." -ForegroundColor Yellow
$buildResult = dotnet build lib\EasyAF.Data\EasyAF.Data.csproj 2>&1

if ($LASTEXITCODE -eq 0) {
    Write-Host "`n??????????????????????????????????????????????????????????????" -ForegroundColor Green -BackgroundColor Black
    Write-Host "?                  ? BUILD SUCCESSFUL! ?                   ?" -ForegroundColor Green -BackgroundColor Black
    Write-Host "??????????????????????????????????????????????????????????????" -ForegroundColor Green -BackgroundColor Black
    Write-Host "`n?? ALL 34 EASYPOWER MODELS COMPILE SUCCESSFULLY! ??`n" -ForegroundColor Green -BackgroundColor Black
} else {
    Write-Host "`n? BUILD FAILED" -ForegroundColor Red
    $buildResult | Select-String "error CS" | Select-Object -First 10
}
