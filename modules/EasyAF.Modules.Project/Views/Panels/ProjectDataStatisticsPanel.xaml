<UserControl x:Class="EasyAF.Modules.Project.Views.Panels.ProjectDataStatisticsPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:conv="clr-namespace:EasyAF.Modules.Project.Converters"
             xmlns:behaviors="clr-namespace:EasyAF.Modules.Project.Behaviors"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors">
    <UserControl.Resources>
        <!-- Converters -->
        <conv:MultiplyConverter x:Key="MultiplyConverter"/>
        <conv:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter"/>
        <conv:BooleanToFontWeightConverter x:Key="BooleanToFontWeightConverter"/>
        <conv:ComparisonConverter x:Key="ComparisonConverter"/>
        <conv:DeltaToColorConverter x:Key="DeltaToColorConverter"/>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </UserControl.Resources>
    
    <GroupBox Header="Project Data" 
              Margin="0,0,22,16"
              HorizontalAlignment="Stretch"
              BorderBrush="{DynamicResource ControlBorderBrush}"
              Foreground="{DynamicResource TextPrimaryBrush}">
        <Grid Margin="8">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            
            <!-- Data Statistics Table -->
            <Grid Grid.Row="0" x:Name="StatisticsTableContainer">
                <!-- Background rounded rectangles for New Data and Old Data columns -->
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="1.5*"/> <!-- Data Type column (proportional) -->
                    <ColumnDefinition Width="*"/>    <!-- New Data column (stretchable) -->
                    <ColumnDefinition Width="*"/>    <!-- Old Data column (stretchable) -->
                    <ColumnDefinition Width="0.8*"/> <!-- Delta column (smaller) -->
                </Grid.ColumnDefinitions>
                
                <!-- New Data Column Background - dynamically sized to match DataGrid height -->
                <Border Grid.Column="1"
                        x:Name="NewDataBackground"
                        Background="Transparent"
                        BorderBrush="{DynamicResource ControlBorderBrush}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Margin="6,4,3,-2"
                        VerticalAlignment="Stretch"/>
                
                <!-- Old Data Column Background - dynamically sized to match DataGrid height -->
                <Border Grid.Column="2"
                        x:Name="OldDataBackground"
                        Background="Transparent"
                        BorderBrush="{DynamicResource ControlBorderBrush}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Margin="3,4,6,-2"
                        VerticalAlignment="Stretch"/>
                
                <!-- DataGrid on top of backgrounds - DISABLE ALL SCROLLING -->
                <DataGrid Grid.Column="0" Grid.ColumnSpan="4"
                          ItemsSource="{Binding VisibleStatisticsRows}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          HeadersVisibility="Column"
                          GridLinesVisibility="None"
                          BorderThickness="0"
                          BorderBrush="Transparent"
                          Background="Transparent"
                          RowBackground="Transparent"
                          AlternatingRowBackground="Transparent"
                          Foreground="{DynamicResource TextPrimaryBrush}"
                          CanUserAddRows="False"
                          CanUserDeleteRows="False"
                          CanUserReorderColumns="False"
                          CanUserResizeRows="False"
                          CanUserSortColumns="False"
                          SelectionMode="Single"
                          SelectionUnit="FullRow"
                          HorizontalGridLinesBrush="Transparent"
                          VerticalGridLinesBrush="Transparent"
                          ScrollViewer.VerticalScrollBarVisibility="Disabled"
                          ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                          ScrollViewer.CanContentScroll="False">
                
                <!-- DataGrid Style -->
                <DataGrid.Resources>
                    <!-- Header Style - transparent background, no bottom border -->
                    <Style TargetType="DataGridColumnHeader">
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
                        <Setter Property="FontWeight" Value="SemiBold"/>
                        <Setter Property="FontSize" Value="13"/>
                        <Setter Property="Padding" Value="12,12,12,8"/>
                        <Setter Property="BorderThickness" Value="0"/>
                        <Setter Property="HorizontalContentAlignment" Value="Center"/>
                    </Style>
                    
                    <!-- Row Style - transparent, child rows handled by cell templates -->
                    <Style TargetType="DataGridRow">
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="BorderThickness" Value="0"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="{DynamicResource HoverBackgroundBrush}"/>
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="{DynamicResource AccentBackgroundBrush}"/>
                                <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                    
                    <!-- Cell Style -->
                    <Style TargetType="DataGridCell">
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="BorderThickness" Value="0"/>
                        <Setter Property="Padding" Value="0"/>
                        <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                        <Style.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </DataGrid.Resources>
                
                <DataGrid.Columns>
                    <!-- Data Type Column with Expander -->
                    <DataGridTemplateColumn Width="1.5*">
                        <DataGridTemplateColumn.HeaderStyle>
                            <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource {x:Type DataGridColumnHeader}}">
                                <Setter Property="HorizontalContentAlignment" Value="Left"/>
                            </Style>
                        </DataGridTemplateColumn.HeaderStyle>
                        <DataGridTemplateColumn.HeaderTemplate>
                            <DataTemplate>
                                <TextBlock Text="Data Type" FontWeight="SemiBold"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.HeaderTemplate>
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Grid>
                                    <!-- Custom drawn border container with shaded backgrounds for children -->
                                    <Grid Margin="0">
                                        <Border Visibility="{Binding IsFirstChild, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                Background="{DynamicResource SecondaryBackgroundBrush}"
                                                BorderBrush="{DynamicResource ControlBorderBrush}"
                                                BorderThickness="1,1,1,0"
                                                CornerRadius="4,4,0,0"
                                                Margin="0,3,0,0"/>
                                        <Border Visibility="{Binding IsMiddleChild, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                Background="{DynamicResource SecondaryBackgroundBrush}"
                                                BorderBrush="{DynamicResource ControlBorderBrush}"
                                                BorderThickness="1,0,1,0"/>
                                        <Border Visibility="{Binding IsLastChild, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                Background="{DynamicResource SecondaryBackgroundBrush}"
                                                BorderBrush="{DynamicResource ControlBorderBrush}"
                                                BorderThickness="1,0,1,1"
                                                CornerRadius="0,0,4,4"
                                                Margin="0,0,0,3"/>
                                    </Grid>
                                    
                                    <StackPanel Orientation="Horizontal" Margin="12,6">
                                        <Border Width="{Binding IndentLevel, Converter={StaticResource MultiplyConverter}, ConverterParameter=24}"/>
                                        <ToggleButton IsChecked="{Binding IsExpanded, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                      Visibility="{Binding ShowExpander, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                      Width="14" Height="14" Margin="0,0,8,0" VerticalAlignment="Center">
                                            <ToggleButton.Template>
                                                <ControlTemplate TargetType="ToggleButton">
                                                    <Border Background="Transparent">
                                                        <Path x:Name="ExpanderTriangle"
                                                              Data="M 0,0 L 5,5 L 0,10 Z"
                                                              Fill="{DynamicResource TextPrimaryBrush}"
                                                              Stretch="Uniform" Width="8" Height="8"
                                                              HorizontalAlignment="Center" VerticalAlignment="Center"
                                                              RenderTransformOrigin="0.5,0.5">
                                                            <Path.RenderTransform>
                                                                <RotateTransform Angle="0"/>
                                                            </Path.RenderTransform>
                                                        </Path>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsChecked" Value="True">
                                                            <Trigger.EnterActions>
                                                                <BeginStoryboard>
                                                                    <Storyboard>
                                                                        <DoubleAnimation Storyboard.TargetName="ExpanderTriangle"
                                                                                       Storyboard.TargetProperty="(Path.RenderTransform).(RotateTransform.Angle)"
                                                                                       To="90" Duration="0:0:0.15"/>
                                                                    </Storyboard>
                                                                </BeginStoryboard>
                                                            </Trigger.EnterActions>
                                                            <Trigger.ExitActions>
                                                                <BeginStoryboard>
                                                                    <Storyboard>
                                                                        <DoubleAnimation Storyboard.TargetName="ExpanderTriangle"
                                                                                       Storyboard.TargetProperty="(Path.RenderTransform).(RotateTransform.Angle)"
                                                                                       To="0" Duration="0:0:0.15"/>
                                                                    </Storyboard>
                                                                </BeginStoryboard>
                                                            </Trigger.ExitActions>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </ToggleButton.Template>
                                        </ToggleButton>
                                        <Border Width="22" Visibility="{Binding ShowExpander, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>
                                        <TextBlock Text="{Binding DisplayName}" 
                                                   FontWeight="{Binding IsRootRow, Converter={StaticResource BooleanToFontWeightConverter}}"
                                                   Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding WarningIndicator}" Margin="8,0,0,0"
                                                   FontFamily="Segoe MDL2 Assets" FontSize="14" VerticalAlignment="Center"
                                                   Foreground="{DynamicResource WarningBrush}"
                                                   ToolTip="Scenario counts are inconsistent"/>
                                    </StackPanel>
                                </Grid>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- New Data Column -->
                    <DataGridTemplateColumn Width="*">
                        <DataGridTemplateColumn.HeaderTemplate>
                            <DataTemplate>
                                <TextBlock Text="New Data" HorizontalAlignment="Center" FontWeight="SemiBold" Margin="0,0,0,4"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.HeaderTemplate>
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Grid>
                                    <Grid Margin="10,0">
                                        <Border Visibility="{Binding IsRootRow, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                Background="Transparent" BorderBrush="{DynamicResource ControlBorderBrush}"
                                                BorderThickness="1" CornerRadius="4" Margin="0,3" Padding="10,6">
                                            <i:Interaction.Behaviors>
                                                <behaviors:CellHighlightBehavior IsHighlighted="{Binding IsNewCountHighlighted, Mode=OneWay}" 
                                                                                 
                                                                                 IsNewData="True" HoldDuration="0:0:2"/>
                                            </i:Interaction.Behaviors>
                                            <TextBlock Text="{Binding NewCountDisplay}" TextAlignment="Center"
                                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                                       VerticalAlignment="Center" HorizontalAlignment="Center" FontWeight="SemiBold"/>
                                        </Border>
                                        <Border Visibility="{Binding IsFirstChild, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                Background="{DynamicResource SecondaryBackgroundBrush}"
                                                BorderBrush="{DynamicResource ControlBorderBrush}"
                                                BorderThickness="1,1,1,0" CornerRadius="4,4,0,0" Margin="0,3,0,0" Padding="10,6">
                                            <i:Interaction.Behaviors>
                                                <behaviors:CellHighlightBehavior IsHighlighted="{Binding IsNewCountHighlighted, Mode=OneWay}" 
                                                                                 
                                                                                 IsNewData="True" HoldDuration="0:0:2"/>
                                            </i:Interaction.Behaviors>
                                            <TextBlock Text="{Binding NewCountDisplay}" TextAlignment="Center"
                                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                                       VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                        </Border>
                                        <Border Visibility="{Binding IsMiddleChild, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                Background="{DynamicResource SecondaryBackgroundBrush}"
                                                BorderBrush="{DynamicResource ControlBorderBrush}"
                                                BorderThickness="1,0,1,0" Padding="10,6">
                                            <i:Interaction.Behaviors>
                                                <behaviors:CellHighlightBehavior IsHighlighted="{Binding IsNewCountHighlighted, Mode=OneWay}" 
                                                                                 
                                                                                 IsNewData="True" HoldDuration="0:0:2"/>
                                            </i:Interaction.Behaviors>
                                            <TextBlock Text="{Binding NewCountDisplay}" TextAlignment="Center"
                                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                                       VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                        </Border>
                                        <Border Visibility="{Binding IsLastChild, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                Background="{DynamicResource SecondaryBackgroundBrush}"
                                                BorderBrush="{DynamicResource ControlBorderBrush}"
                                                BorderThickness="1,0,1,1" CornerRadius="0,0,4,4" Margin="0,0,0,3" Padding="10,6">
                                            <i:Interaction.Behaviors>
                                                <behaviors:CellHighlightBehavior IsHighlighted="{Binding IsNewCountHighlighted, Mode=OneWay}" 
                                                                                 
                                                                                 IsNewData="True" HoldDuration="0:0:2"/>
                                            </i:Interaction.Behaviors>
                                            <TextBlock Text="{Binding NewCountDisplay}" TextAlignment="Center"
                                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                                       VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                        </Border>
                                    </Grid>
                                </Grid>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- Old Data Column -->
                    <DataGridTemplateColumn Width="*">
                        <DataGridTemplateColumn.HeaderTemplate>
                            <DataTemplate>
                                <TextBlock Text="Old Data" HorizontalAlignment="Center" FontWeight="SemiBold" Margin="0,0,0,4"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.HeaderTemplate>
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Grid>
                                    <Grid Margin="10,0">
                                        <Border Visibility="{Binding IsRootRow, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                Background="Transparent" BorderBrush="{DynamicResource ControlBorderBrush}"
                                                BorderThickness="1" CornerRadius="4" Margin="0,3" Padding="10,6">
                                            <i:Interaction.Behaviors>
                                                <behaviors:CellHighlightBehavior IsHighlighted="{Binding IsOldCountHighlighted, Mode=OneWay}" 
                                                                                 
                                                                                 IsNewData="False" HoldDuration="0:0:2"/>
                                            </i:Interaction.Behaviors>
                                            <TextBlock Text="{Binding OldCountDisplay}" TextAlignment="Center"
                                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                                       VerticalAlignment="Center" HorizontalAlignment="Center" FontWeight="SemiBold"/>
                                        </Border>
                                        <Border Visibility="{Binding IsFirstChild, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                Background="{DynamicResource SecondaryBackgroundBrush}"
                                                BorderBrush="{DynamicResource ControlBorderBrush}"
                                                BorderThickness="1,1,1,0" CornerRadius="4,4,0,0" Margin="0,3,0,0" Padding="10,6">
                                            <i:Interaction.Behaviors>
                                                <behaviors:CellHighlightBehavior IsHighlighted="{Binding IsOldCountHighlighted, Mode=OneWay}" 
                                                                                 
                                                                                 IsNewData="False" HoldDuration="0:0:2"/>
                                            </i:Interaction.Behaviors>
                                            <TextBlock Text="{Binding OldCountDisplay}" TextAlignment="Center"
                                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                                       VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                        </Border>
                                        <Border Visibility="{Binding IsMiddleChild, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                Background="{DynamicResource SecondaryBackgroundBrush}"
                                                BorderBrush="{DynamicResource ControlBorderBrush}"
                                                BorderThickness="1,0,1,0" Padding="10,6">
                                            <i:Interaction.Behaviors>
                                                <behaviors:CellHighlightBehavior IsHighlighted="{Binding IsOldCountHighlighted, Mode=OneWay}" 
                                                                                 
                                                                                 IsNewData="False" HoldDuration="0:0:2"/>
                                            </i:Interaction.Behaviors>
                                            <TextBlock Text="{Binding OldCountDisplay}" TextAlignment="Center"
                                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                                       VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                        </Border>
                                        <Border Visibility="{Binding IsLastChild, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                Background="{DynamicResource SecondaryBackgroundBrush}"
                                                BorderBrush="{DynamicResource ControlBorderBrush}"
                                                BorderThickness="1,0,1,1" CornerRadius="0,0,4,4" Margin="0,0,0,3" Padding="10,6">
                                            <i:Interaction.Behaviors>
                                                <behaviors:CellHighlightBehavior IsHighlighted="{Binding IsOldCountHighlighted, Mode=OneWay}" 
                                                                                 
                                                                                 IsNewData="False" HoldDuration="0:0:2"/>
                                            </i:Interaction.Behaviors>
                                            <TextBlock Text="{Binding OldCountDisplay}" TextAlignment="Center"
                                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                                       VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                        </Border>
                                    </Grid>
                                </Grid>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- Delta Column -->
                    <DataGridTemplateColumn Width="0.8*">
                        <DataGridTemplateColumn.HeaderTemplate>
                            <DataTemplate>
                                <TextBlock Text="Difference" HorizontalAlignment="Center" FontWeight="SemiBold" Margin="0,0,0,4"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.HeaderTemplate>
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Grid>
                                    <TextBlock Text="{Binding DeltaDisplay}" TextAlignment="Center" Margin="12,6"
                                               Foreground="{Binding Delta, Converter={StaticResource DeltaToColorConverter}}"
                                               FontWeight="{Binding DeltaFontWeight}"
                                               VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                </Grid>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
            
            <!-- Transparent drop zone overlays -->
            <Border Grid.Column="1" x:Name="NewDataDropZone" Background="Transparent" IsHitTestVisible="True" Margin="6,0,3,0">
                <i:Interaction.Behaviors>
                    <behaviors:ImportDropBehavior IsNewData="True" ViewModel="{Binding}"/>
                </i:Interaction.Behaviors>
            </Border>
            <Border Grid.Column="2" x:Name="OldDataDropZone" Background="Transparent" IsHitTestVisible="True" Margin="3,0,6,0">
                <i:Interaction.Behaviors>
                    <behaviors:ImportDropBehavior IsNewData="False" ViewModel="{Binding}"/>
                </i:Interaction.Behaviors>
            </Border>
        </Grid>
    </Grid>
</GroupBox>
</UserControl>
