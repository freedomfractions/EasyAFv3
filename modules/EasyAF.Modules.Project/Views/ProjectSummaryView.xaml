<UserControl x:Class="EasyAF.Modules.Project.Views.ProjectSummaryView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:conv="clr-namespace:EasyAF.Modules.Project.Converters"
             xmlns:local="clr-namespace:EasyAF.Modules.Project.ViewModels"
             HorizontalAlignment="Stretch"
             VerticalAlignment="Stretch">
    <UserControl.Resources>
        <!-- Force GroupBox content to stretch -->
        <Style TargetType="GroupBox" BasedOn="{StaticResource {x:Type GroupBox}}">
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
        </Style>
        
        <!-- Converters -->
        <conv:MultiplyConverter x:Key="MultiplyConverter"/>
        <conv:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter"/>
        <conv:BooleanToFontWeightConverter x:Key="BooleanToFontWeightConverter"/>
        <conv:ComparisonConverter x:Key="ComparisonConverter"/>
        <conv:DeltaToColorConverter x:Key="DeltaToColorConverter"/>
        
        <!-- Boolean to Visibility Converters -->
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        
        <!-- Right-aligned TextBlock Style -->
        <Style x:Key="RightAlignedTextBlockStyle" TargetType="TextBlock">
            <Setter Property="HorizontalAlignment" Value="Right"/>
            <Setter Property="TextAlignment" Value="Right"/>
            <Setter Property="Margin" Value="0,0,10,0"/>
        </Style>
        
        <!-- Expander Toggle Button Style -->
        <Style x:Key="ExpanderToggleButtonStyle" TargetType="ToggleButton">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border Background="Transparent">
                            <TextBlock x:Name="ExpanderIcon" 
                                       Text="?" 
                                       FontSize="10"
                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="ExpanderIcon" Property="Text" Value="?"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>
    
    <ScrollViewer VerticalScrollBarVisibility="Auto"
                  HorizontalScrollBarVisibility="Disabled"
                  Background="{DynamicResource PrimaryBackgroundBrush}"
                  HorizontalAlignment="Stretch"
                  VerticalAlignment="Stretch"
                  Padding="0,0,0,0">
        <!-- Bind inner Grid width to viewport so ScrollViewer's infinite measure doesn't collapse stretch -->
        <!-- Constrain to reasonable max width for readability -->
        <Grid Margin="20,20,0,20"
              Width="{Binding ViewportWidth, RelativeSource={RelativeSource AncestorType=ScrollViewer}}"
              MaxWidth="1200"
              x:Name="MainProjectGrid">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            
            <!-- Project GroupBox -->
            <GroupBox Grid.Row="0"
                      Header="Project" 
                      Margin="0,0,22,16"
                      HorizontalAlignment="Stretch"
                      BorderBrush="{DynamicResource ControlBorderBrush}"
                      Foreground="{DynamicResource TextPrimaryBrush}">
                <Grid x:Name="ProjectFieldsGrid" Margin="8" Grid.IsSharedSizeScope="True">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" SharedSizeGroup="Label1"/>    <!-- Label 1 - auto-size to content -->
                        <ColumnDefinition Width="1.5*"/>    <!-- Values column 1 (proportional) -->
                        <ColumnDefinition Width="Auto" SharedSizeGroup="Label2"/>    <!-- Label 2 - auto-size to content -->
                        <ColumnDefinition Width="2*"/>      <!-- Values column 2 (more space) -->
                        <ColumnDefinition Width="Auto"/>    <!-- State label - auto-size -->
                        <ColumnDefinition Width="0.5*"/>    <!-- State field - minimal stretch -->
                        <ColumnDefinition Width="Auto"/>    <!-- Zip label - auto-size -->
                        <ColumnDefinition Width="0.5*"/>    <!-- Zip field - minimal stretch -->
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="32"/>
                        <RowDefinition Height="32"/>
                        <RowDefinition Height="32"/>
                        <RowDefinition Height="32"/>
                        <RowDefinition Height="32"/>
                        <RowDefinition Height="32"/>
                        <RowDefinition Height="32"/>
                        <RowDefinition Height="8"/>   <!-- Spacer row before Comments (reduced from 16) -->
                        <RowDefinition Height="80"/>  <!-- Comments row -->
                        <RowDefinition Height="8"/>   <!-- Spacer row before Project Type (reduced from 16) -->
                        <RowDefinition Height="32"/>  <!-- Project Type row -->
                    </Grid.RowDefinitions>
                    
                    <!-- Row 0: LB Project Number | Site Name -->
                    <TextBlock Grid.Row="0" Grid.Column="0" Text="LB Project Number:" VerticalAlignment="Center" Margin="0,0,8,0" Foreground="{DynamicResource TextPrimaryBrush}"/>
                    <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding LBProjectNumber, UpdateSourceTrigger=PropertyChanged}" VerticalAlignment="Center" Margin="0,0,20,0" HorizontalAlignment="Stretch"/>
                    
                    <TextBlock Grid.Row="0" Grid.Column="2" Text="Site Name:" VerticalAlignment="Center" Margin="0,0,8,0" Foreground="{DynamicResource TextPrimaryBrush}"/>
                    <TextBox Grid.Row="0" Grid.Column="3" Grid.ColumnSpan="5" Text="{Binding SiteName, UpdateSourceTrigger=PropertyChanged}" VerticalAlignment="Center" HorizontalAlignment="Stretch"/>
                    
                    <!-- Row 1: Client | Study Engineer -->
                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Client:" VerticalAlignment="Center" Margin="0,0,8,0" Foreground="{DynamicResource TextPrimaryBrush}"/>
                    <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding Client, UpdateSourceTrigger=PropertyChanged}" VerticalAlignment="Center" Margin="0,0,20,0" HorizontalAlignment="Stretch"/>
                    
                    <TextBlock Grid.Row="1" Grid.Column="2" Text="Study Engineer:" VerticalAlignment="Center" Margin="0,0,8,0" Foreground="{DynamicResource TextPrimaryBrush}"/>
                    <TextBox Grid.Row="1" Grid.Column="3" Grid.ColumnSpan="5" Text="{Binding StudyEngineer, UpdateSourceTrigger=PropertyChanged}" VerticalAlignment="Center" HorizontalAlignment="Stretch"/>
                    
                    <!-- Row 2: Address Line 1 -->
                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Address Line 1:" VerticalAlignment="Center" Margin="0,0,8,0" Foreground="{DynamicResource TextPrimaryBrush}"/>
                    <TextBox Grid.Row="2" Grid.Column="1" Grid.ColumnSpan="7" Text="{Binding AddressLine1, UpdateSourceTrigger=PropertyChanged}" VerticalAlignment="Center" HorizontalAlignment="Stretch"/>
                    
                    <!-- Row 3: Address Line 2 -->
                    <TextBlock Grid.Row="3" Grid.Column="0" Text="Address Line 2:" VerticalAlignment="Center" Margin="0,0,8,0" Foreground="{DynamicResource TextPrimaryBrush}"/>
                    <TextBox Grid.Row="3" Grid.Column="1" Grid.ColumnSpan="7" Text="{Binding AddressLine2, UpdateSourceTrigger=PropertyChanged}" VerticalAlignment="Center" HorizontalAlignment="Stretch"/>
                    
                    <!-- Row 4: Address Line 3 -->
                    <TextBlock Grid.Row="4" Grid.Column="0" Text="Address Line 3:" VerticalAlignment="Center" Margin="0,0,8,0" Foreground="{DynamicResource TextPrimaryBrush}"/>
                    <TextBox Grid.Row="4" Grid.Column="1" Grid.ColumnSpan="7" Text="{Binding AddressLine3, UpdateSourceTrigger=PropertyChanged}" VerticalAlignment="Center" HorizontalAlignment="Stretch"/>
                    
                    <!-- Row 5: City | State | Zip - Nested grid with 90% growth rate -->
                    <Grid Grid.Row="5" Grid.Column="0" Grid.ColumnSpan="8" HorizontalAlignment="Left"
                          Width="{Binding ActualWidth, ElementName=ProjectFieldsGrid, Converter={StaticResource MultiplyConverter}, ConverterParameter=0.9}"
                          MaxWidth="1080">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" SharedSizeGroup="Label1"/>    <!-- Label: City - matches main grid -->
                            <ColumnDefinition Width="1.5*"/>    <!-- Field: City -->
                            <ColumnDefinition Width="Auto"/>    <!-- Label: State -->
                            <ColumnDefinition Width="0.5*"/>    <!-- Field: State -->
                            <ColumnDefinition Width="Auto"/>    <!-- Label: Zip -->
                            <ColumnDefinition Width="0.5*"/>    <!-- Field: Zip -->
                        </Grid.ColumnDefinitions>
                        
                        <TextBlock Grid.Column="0" Text="City:" VerticalAlignment="Center" Margin="0,0,8,0" Foreground="{DynamicResource TextPrimaryBrush}"/>
                        <TextBox Grid.Column="1" Text="{Binding City, UpdateSourceTrigger=PropertyChanged}" VerticalAlignment="Center" Margin="0,0,20,0" HorizontalAlignment="Stretch"/>
                        
                        <TextBlock Grid.Column="2" Text="State:" VerticalAlignment="Center" Margin="0,0,8,0" Foreground="{DynamicResource TextPrimaryBrush}"/>
                        <ComboBox Grid.Column="3" SelectedItem="{Binding State, UpdateSourceTrigger=PropertyChanged}" 
                                  VerticalAlignment="Center" Margin="0,0,20,0" HorizontalAlignment="Stretch" IsEditable="True">
                            <ComboBox.Items>
                                <ComboBoxItem Content="AL"/>
                                <ComboBoxItem Content="AK"/>
                                <ComboBoxItem Content="AZ"/>
                                <ComboBoxItem Content="AR"/>
                                <ComboBoxItem Content="CA"/>
                                <ComboBoxItem Content="CO"/>
                                <ComboBoxItem Content="CT"/>
                                <ComboBoxItem Content="DE"/>
                                <ComboBoxItem Content="FL"/>
                                <ComboBoxItem Content="GA"/>
                                <ComboBoxItem Content="HI"/>
                                <ComboBoxItem Content="ID"/>
                                <ComboBoxItem Content="IL"/>
                                <ComboBoxItem Content="IN"/>
                                <ComboBoxItem Content="IA"/>
                                <ComboBoxItem Content="KS"/>
                                <ComboBoxItem Content="KY"/>
                                <ComboBoxItem Content="LA"/>
                                <ComboBoxItem Content="ME"/>
                                <ComboBoxItem Content="MD"/>
                                <ComboBoxItem Content="MA"/>
                                <ComboBoxItem Content="MI"/>
                                <ComboBoxItem Content="MN"/>
                                <ComboBoxItem Content="MS"/>
                                <ComboBoxItem Content="MO"/>
                                <ComboBoxItem Content="MT"/>
                                <ComboBoxItem Content="NE"/>
                                <ComboBoxItem Content="NV"/>
                                <ComboBoxItem Content="NH"/>
                                <ComboBoxItem Content="NJ"/>
                                <ComboBoxItem Content="NM"/>
                                <ComboBoxItem Content="NY"/>
                                <ComboBoxItem Content="NC"/>
                                <ComboBoxItem Content="ND"/>
                                <ComboBoxItem Content="OH"/>
                                <ComboBoxItem Content="OK"/>
                                <ComboBoxItem Content="OR"/>
                                <ComboBoxItem Content="PA"/>
                                <ComboBoxItem Content="RI"/>
                                <ComboBoxItem Content="SC"/>
                                <ComboBoxItem Content="SD"/>
                                <ComboBoxItem Content="TN"/>
                                <ComboBoxItem Content="TX"/>
                                <ComboBoxItem Content="UT"/>
                                <ComboBoxItem Content="VT"/>
                                <ComboBoxItem Content="VA"/>
                                <ComboBoxItem Content="WA"/>
                                <ComboBoxItem Content="WV"/>
                                <ComboBoxItem Content="WI"/>
                                <ComboBoxItem Content="WY"/>
                            </ComboBox.Items>
                        </ComboBox>
                        
                        <TextBlock Grid.Column="4" Text="Zip:" VerticalAlignment="Center" Margin="0,0,8,0" Foreground="{DynamicResource TextPrimaryBrush}"/>
                        <TextBox Grid.Column="5" Text="{Binding Zip, UpdateSourceTrigger=PropertyChanged}" VerticalAlignment="Center" MaxLength="5" HorizontalAlignment="Stretch"/>
                    </Grid>
                    
                    <!-- Row 6: Study Date | Revision Month - Nested grid with 90% growth rate -->
                    <Grid Grid.Row="6" Grid.Column="0" Grid.ColumnSpan="8" HorizontalAlignment="Left"
                          Width="{Binding ActualWidth, ElementName=ProjectFieldsGrid, Converter={StaticResource MultiplyConverter}, ConverterParameter=0.9}"
                          MaxWidth="1080">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" SharedSizeGroup="Label1"/>    <!-- Label: Study Date - matches main grid -->
                            <ColumnDefinition Width="1*"/>      <!-- Field: Study Date -->
                            <ColumnDefinition Width="Auto"/>    <!-- Label: Revision -->
                            <ColumnDefinition Width="1.5*"/>    <!-- Field: Revision -->
                        </Grid.ColumnDefinitions>
                        
                        <TextBlock Grid.Column="0" Text="Study Date:" VerticalAlignment="Center" Margin="0,0,8,0" Foreground="{DynamicResource TextPrimaryBrush}"/>
                        <DatePicker Grid.Column="1" SelectedDate="{Binding StudyDateValue, UpdateSourceTrigger=PropertyChanged}" VerticalAlignment="Center" Margin="0,0,20,0" HorizontalAlignment="Stretch"/>
                        
                        <TextBlock Grid.Column="2" Text="Revision Month:" VerticalAlignment="Center" Margin="0,0,8,0" Foreground="{DynamicResource TextPrimaryBrush}"/>
                        <TextBox Grid.Column="3" Text="{Binding Revision, UpdateSourceTrigger=PropertyChanged}" VerticalAlignment="Center" HorizontalAlignment="Stretch"/>
                    </Grid>
                    
                    <!-- Row 7: Spacer (empty) -->
                    
                    <!-- Row 8: Comments -->
                    <TextBlock Grid.Row="8" Grid.Column="0" Text="Comments:" VerticalAlignment="Top" Margin="0,4,8,0" Foreground="{DynamicResource TextPrimaryBrush}"/>
                    <TextBox Grid.Row="8" Grid.Column="1" Grid.ColumnSpan="7" 
                             Text="{Binding Comments, UpdateSourceTrigger=PropertyChanged}" 
                             TextWrapping="Wrap" 
                             AcceptsReturn="True" 
                             VerticalScrollBarVisibility="Auto"
                             HorizontalAlignment="Stretch"
                             VerticalAlignment="Stretch"/>
                    
                    <!-- Row 9: Spacer (empty) -->
                    
                    <!-- Row 10: Project Type -->
                    <TextBlock Grid.Row="10" Grid.Column="0" Text="Project Type:" VerticalAlignment="Center" Margin="0,0,8,0" Foreground="{DynamicResource TextPrimaryBrush}"/>
                    <StackPanel Grid.Row="10" Grid.Column="1" Grid.ColumnSpan="7" Orientation="Horizontal">
                        <RadioButton Content="Standard EasyPower Model" 
                                     IsChecked="{Binding IsStandardProjectType}" 
                                     GroupName="ProjectType" 
                                     Margin="0,0,20,0"
                                     VerticalAlignment="Center"/>
                        <RadioButton Content="Composite Model" 
                                     IsChecked="{Binding IsCompositeProjectType}" 
                                     GroupName="ProjectType"
                                     VerticalAlignment="Center"/>
                    </StackPanel>
                </Grid>
            </GroupBox>
            
            <!-- Project Summary GroupBox -->
            <GroupBox Grid.Row="1"
                      Header="Project Summary" 
                      Margin="0,0,22,16"
                      HorizontalAlignment="Stretch"
                      BorderBrush="{DynamicResource ControlBorderBrush}"
                      Foreground="{DynamicResource TextPrimaryBrush}">
                <Grid Margin="8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Import Buttons Row -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                        <Button Content="Import New Data..."
                                Command="{Binding ImportNewDataCommand}"
                                Style="{StaticResource BaseButtonStyle}"
                                Padding="12,6"
                                Margin="0,0,10,0"/>
                        <Button Content="Import Old Data..."
                                Command="{Binding ImportOldDataCommand}"
                                Style="{StaticResource BaseButtonStyle}"
                                Padding="12,6"/>
                    </StackPanel>
                    
                    <!-- Data Statistics Table -->
                    <Grid Grid.Row="2">
                        <!-- Background rounded rectangles for New Data and Old Data columns -->
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="1.5*"/> <!-- Data Type column (proportional) -->
                            <ColumnDefinition Width="*"/>    <!-- New Data column (stretchable) -->
                            <ColumnDefinition Width="*"/>    <!-- Old Data column (stretchable) -->
                            <ColumnDefinition Width="0.8*"/> <!-- Delta column (smaller) -->
                        </Grid.ColumnDefinitions>
                        
                        <!-- New Data Column Background - BOLDER with drop shadow -->
                        <Border Grid.Column="1"
                                Background="{DynamicResource SecondaryBackgroundBrush}"
                                BorderBrush="{DynamicResource ControlBorderBrush}"
                                BorderThickness="3"
                                CornerRadius="10"
                                Margin="6,4,3,4"
                                Opacity="0.4">
                            <Border.Effect>
                                <DropShadowEffect Color="{DynamicResource ControlBorderColor}" 
                                                  BlurRadius="8" 
                                                  ShadowDepth="2" 
                                                  Opacity="0.3"/>
                            </Border.Effect>
                        </Border>
                        
                        <!-- Old Data Column Background - BOLDER with drop shadow -->
                        <Border Grid.Column="2"
                                Background="{DynamicResource SecondaryBackgroundBrush}"
                                BorderBrush="{DynamicResource ControlBorderBrush}"
                                BorderThickness="3"
                                CornerRadius="10"
                                Margin="3,4,6,4"
                                Opacity="0.4">
                            <Border.Effect>
                                <DropShadowEffect Color="{DynamicResource ControlBorderColor}" 
                                                  BlurRadius="8" 
                                                  ShadowDepth="2" 
                                                  Opacity="0.3"/>
                            </Border.Effect>
                        </Border>
                        
                        <!-- DataGrid on top of backgrounds -->
                        <DataGrid Grid.Column="0" Grid.ColumnSpan="4"
                                  ItemsSource="{Binding VisibleStatisticsRows}"
                                  AutoGenerateColumns="False"
                                  IsReadOnly="True"
                                  HeadersVisibility="Column"
                                  GridLinesVisibility="None"
                                  BorderThickness="0"
                                  BorderBrush="Transparent"
                                  Background="Transparent"
                                  RowBackground="Transparent"
                                  AlternatingRowBackground="Transparent"
                                  Foreground="{DynamicResource TextPrimaryBrush}"
                                  CanUserAddRows="False"
                                  CanUserDeleteRows="False"
                                  CanUserReorderColumns="False"
                                  CanUserResizeRows="False"
                                  CanUserSortColumns="False"
                                  SelectionMode="Single"
                                  SelectionUnit="FullRow"
                                  HorizontalGridLinesBrush="Transparent"
                                  VerticalGridLinesBrush="Transparent">
                        
                        <!-- DataGrid Style -->
                        <DataGrid.Resources>
                            <!-- Header Style - transparent background, no bottom border -->
                            <Style TargetType="DataGridColumnHeader">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
                                <Setter Property="FontWeight" Value="SemiBold"/>
                                <Setter Property="FontSize" Value="13"/>
                                <Setter Property="Padding" Value="12,12,12,8"/>
                                <Setter Property="BorderThickness" Value="0"/>
                                <Setter Property="HorizontalContentAlignment" Value="Left"/>
                            </Style>
                            
                            <!-- Row Style - transparent, child rows handled by cell templates -->
                            <Style TargetType="DataGridRow">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="BorderThickness" Value="0"/>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="{DynamicResource HoverBackgroundBrush}"/>
                                    </Trigger>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter Property="Background" Value="{DynamicResource AccentBackgroundBrush}"/>
                                        <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                            
                            <!-- Cell Style -->
                            <Style TargetType="DataGridCell">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="BorderThickness" Value="0"/>
                                <Setter Property="Padding" Value="0"/>
                                <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                                <Style.Triggers>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter Property="Background" Value="Transparent"/>
                                        <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </DataGrid.Resources>
                        
                        <DataGrid.Columns>
                            <!-- Data Type Column with Expander -->
                            <DataGridTemplateColumn Header="Data Type" Width="1.5*">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Grid>
                                            <!-- Full-width child row background -->
                                            <Border Background="{DynamicResource SecondaryBackgroundBrush}"
                                                    Visibility="{Binding IsRootRow, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>
                                            
                                            <StackPanel Orientation="Horizontal" Margin="12,6">
                                                <!-- Indentation for child rows -->
                                                <Border Width="{Binding IndentLevel, Converter={StaticResource MultiplyConverter}, ConverterParameter=20}"/>
                                                
                                                <!-- Triangle Expander (visible only for parent rows with children) -->
                                                <ToggleButton IsChecked="{Binding IsExpanded, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                              Visibility="{Binding ShowExpander, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                              Width="14"
                                                              Height="14"
                                                              Margin="0,0,8,0"
                                                              VerticalAlignment="Center">
                                                    <ToggleButton.Template>
                                                        <ControlTemplate TargetType="ToggleButton">
                                                            <Border Background="Transparent">
                                                                <Path x:Name="ExpanderTriangle"
                                                                      Data="M 0,0 L 5,5 L 0,10 Z"
                                                                      Fill="{DynamicResource TextPrimaryBrush}"
                                                                      Stretch="Uniform"
                                                                      Width="8"
                                                                      Height="8"
                                                                      HorizontalAlignment="Center"
                                                                      VerticalAlignment="Center"
                                                                      RenderTransformOrigin="0.5,0.5">
                                                                    <Path.RenderTransform>
                                                                        <RotateTransform Angle="0"/>
                                                                    </Path.RenderTransform>
                                                                </Path>
                                                            </Border>
                                                            <ControlTemplate.Triggers>
                                                                <Trigger Property="IsChecked" Value="True">
                                                                    <Trigger.EnterActions>
                                                                        <BeginStoryboard>
                                                                            <Storyboard>
                                                                                <DoubleAnimation Storyboard.TargetName="ExpanderTriangle"
                                                                                               Storyboard.TargetProperty="(Path.RenderTransform).(RotateTransform.Angle)"
                                                                                               To="90"
                                                                                               Duration="0:0:0.15"/>
                                                                            </Storyboard>
                                                                        </BeginStoryboard>
                                                                    </Trigger.EnterActions>
                                                                    <Trigger.ExitActions>
                                                                        <BeginStoryboard>
                                                                            <Storyboard>
                                                                                <DoubleAnimation Storyboard.TargetName="ExpanderTriangle"
                                                                                               Storyboard.TargetProperty="(Path.RenderTransform).(RotateTransform.Angle)"
                                                                                               To="0"
                                                                                               Duration="0:0:0.15"/>
                                                                            </Storyboard>
                                                                        </BeginStoryboard>
                                                                    </Trigger.ExitActions>
                                                                </Trigger>
                                                            </ControlTemplate.Triggers>
                                                        </ControlTemplate>
                                                    </ToggleButton.Template>
                                                </ToggleButton>
                                                
                                                <!-- Spacer for non-expandable rows -->
                                                <Border Width="22" 
                                                        Visibility="{Binding ShowExpander, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>
                                                
                                                <!-- Display Name -->
                                                <TextBlock Text="{Binding DisplayName}" 
                                                           FontWeight="{Binding IsRootRow, Converter={StaticResource BooleanToFontWeightConverter}}"
                                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                                           VerticalAlignment="Center"/>
                                                
                                                <!-- Warning Indicator -->
                                                <TextBlock Text="{Binding WarningIndicator}" 
                                                           Margin="8,0,0,0"
                                                           FontSize="11"
                                                           VerticalAlignment="Center"
                                                           Foreground="{DynamicResource WarningBrush}"
                                                           ToolTip="Scenario counts are inconsistent"/>
                                            </StackPanel>
                                        </Grid>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            
                            <!-- New Data Column - CONNECTED BUBBLE for children -->
                            <DataGridTemplateColumn Width="*">
                                <DataGridTemplateColumn.HeaderTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="New Data" 
                                                   HorizontalAlignment="Center"
                                                   FontWeight="SemiBold"
                                                   Margin="0,0,0,4"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.HeaderTemplate>
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Grid>
                                            <!-- Full-width child row background -->
                                            <Border Background="{DynamicResource SecondaryBackgroundBrush}"
                                                    Visibility="{Binding IsRootRow, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>
                                            
                                            <!-- Individual cell border - NO rounded corners for child rows (connected bubble) -->
                                            <Border Background="Transparent"
                                                    BorderBrush="{DynamicResource ControlBorderBrush}"
                                                    BorderThickness="1"
                                                    Margin="10,3"
                                                    Padding="10,6">
                                                <Border.Style>
                                                    <Style TargetType="Border">
                                                        <!-- Default: rounded corners for root rows -->
                                                        <Setter Property="CornerRadius" Value="4"/>
                                                        <Style.Triggers>
                                                            <!-- Child rows: no rounding (connected bubble effect) -->
                                                            <DataTrigger Binding="{Binding IsRootRow}" Value="False">
                                                                <Setter Property="CornerRadius" Value="0"/>
                                                                <Setter Property="BorderThickness" Value="1,0,1,1"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Border.Style>
                                                <TextBlock Text="{Binding NewCountDisplay}" 
                                                           TextAlignment="Center"
                                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                                           VerticalAlignment="Center"
                                                           HorizontalAlignment="Center"
                                                           FontWeight="{Binding IsRootRow, Converter={StaticResource BooleanToFontWeightConverter}}"/>
                                            </Border>
                                        </Grid>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            
                            <!-- Old Data Column - CONNECTED BUBBLE for children -->
                            <DataGridTemplateColumn Width="*">
                                <DataGridTemplateColumn.HeaderTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="Old Data" 
                                                   HorizontalAlignment="Center"
                                                   FontWeight="SemiBold"
                                                   Margin="0,0,0,4"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.HeaderTemplate>
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Grid>
                                            <!-- Full-width child row background -->
                                            <Border Background="{DynamicResource SecondaryBackgroundBrush}"
                                                    Visibility="{Binding IsRootRow, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>
                                            
                                            <!-- Individual cell border - NO rounded corners for child rows (connected bubble) -->
                                            <Border Background="Transparent"
                                                    BorderBrush="{DynamicResource ControlBorderBrush}"
                                                    BorderThickness="1"
                                                    Margin="10,3"
                                                    Padding="10,6">
                                                <Border.Style>
                                                    <Style TargetType="Border">
                                                        <!-- Default: rounded corners for root rows -->
                                                        <Setter Property="CornerRadius" Value="4"/>
                                                        <Style.Triggers>
                                                            <!-- Child rows: no rounding (connected bubble effect) -->
                                                            <DataTrigger Binding="{Binding IsRootRow}" Value="False">
                                                                <Setter Property="CornerRadius" Value="0"/>
                                                                <Setter Property="BorderThickness" Value="1,0,1,1"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Border.Style>
                                                <TextBlock Text="{Binding OldCountDisplay}" 
                                                           TextAlignment="Center"
                                                           Foreground="{DynamicResource TextSecondaryBrush}"
                                                           VerticalAlignment="Center"
                                                           HorizontalAlignment="Center"
                                                           FontWeight="{Binding IsRootRow, Converter={StaticResource BooleanToFontWeightConverter}}"/>
                                            </Border>
                                        </Grid>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            
                            <!-- Delta Column (placeholder for now) -->
                            <DataGridTemplateColumn Width="0.8*">
                                <DataGridTemplateColumn.HeaderTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="? Change" 
                                                   HorizontalAlignment="Center"
                                                   FontWeight="SemiBold"
                                                   Margin="0,0,0,4"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.HeaderTemplate>
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Grid>
                                            <!-- Full-width child row background -->
                                            <Border Background="{DynamicResource SecondaryBackgroundBrush}"
                                                    Visibility="{Binding IsRootRow, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>
                                            
                                            <TextBlock Text="{Binding DeltaDisplay}"
                                                       TextAlignment="Center"
                                                       Margin="12,6"
                                                       Foreground="{Binding Delta, Converter={StaticResource DeltaToColorConverter}}"
                                                       FontWeight="{Binding DeltaFontWeight}"
                                                       VerticalAlignment="Center"
                                                       HorizontalAlignment="Center"/>
                                        </Grid>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>  <!-- Close inner Grid that contains column backgrounds -->
            </Grid>  <!-- Close outer Grid in GroupBox content -->
        </GroupBox>
            
            <!-- Report GroupBox -->
            <GroupBox Grid.Row="2"
                      Header="Report"
                      Margin="0,0,22,0"
                      HorizontalAlignment="Stretch"
                      BorderBrush="{DynamicResource ControlBorderBrush}"
                      Foreground="{DynamicResource TextPrimaryBrush}">
                <Grid Margin="8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="140"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="32"/>
                        <RowDefinition Height="32"/>
                        <RowDefinition Height="32"/>
                        <RowDefinition Height="32"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Map Path -->
                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Map:" VerticalAlignment="Center" Foreground="{DynamicResource TextPrimaryBrush}"/>
                    <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding MapPath, UpdateSourceTrigger=PropertyChanged}" VerticalAlignment="Center" Margin="0,0,8,0" HorizontalAlignment="Stretch"/>
                    <Button Grid.Row="0" Grid.Column="2" Content="Browse..." Command="{Binding BrowseMapCommand}" Padding="8,4" Style="{StaticResource BaseButtonStyle}"/>
                    
                    <!-- Spec Path -->
                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Spec:" VerticalAlignment="Center" Foreground="{DynamicResource TextPrimaryBrush}"/>
                    <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding SpecPath, UpdateSourceTrigger=PropertyChanged}" VerticalAlignment="Center" Margin="0,0,8,0" HorizontalAlignment="Stretch"/>
                    <Button Grid.Row="1" Grid.Column="2" Content="Browse..." Command="{Binding BrowseSpecCommand}" Padding="8,4" Style="{StaticResource BaseButtonStyle}"/>
                    
                    <!-- Template Path -->
                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Template:" VerticalAlignment="Center" Foreground="{DynamicResource TextPrimaryBrush}"/>
                    <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding TemplatePath, UpdateSourceTrigger=PropertyChanged}" VerticalAlignment="Center" Margin="0,0,8,0" HorizontalAlignment="Stretch"/>
                    <Button Grid.Row="2" Grid.Column="2" Content="Browse..." Command="{Binding BrowseTemplateCommand}" Padding="8,4" Style="{StaticResource BaseButtonStyle}"/>
                    
                    <!-- Output Folder -->
                    <TextBlock Grid.Row="3" Grid.Column="0" Text="Output Folder:" VerticalAlignment="Center" Foreground="{DynamicResource TextPrimaryBrush}"/>
                    <TextBox Grid.Row="3" Grid.Column="1" Text="{Binding OutputPath, UpdateSourceTrigger=PropertyChanged}" VerticalAlignment="Center" Margin="0,0,8,0" HorizontalAlignment="Stretch"/>
                    <Button Grid.Row="3" Grid.Column="2" Content="Browse..." Command="{Binding BrowseOutputCommand}" Padding="8,4" Style="{StaticResource BaseButtonStyle}"/>
                </Grid>
            </GroupBox>
            
        </Grid>
    </ScrollViewer>
</UserControl>
